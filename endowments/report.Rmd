---
title: "Endowments at Crow Canyon:<br>`r params$year - 1` and `r params$year` Distributions"
author: "Ricky Lightfoot, Liz Perry, and Kyle Bocinsky"
date: "`r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: yes
output: 
  bookdown::html_document2:
    df_print: paged
    fig_caption: yes
    toc: false
    toc_float: true
    code_folding: hide
    self_contained: false
    lib_dir: libs
editor_options: 
  chunk_output_type: console
params:
  year: 2021
  r: 0.045
  p: 0.7
  live_data: TRUE
---

```{r setup, include=FALSE}
# Set the behavior for printing scientific notation
options(digits = 3, scipen = 999)
options(shiny.sanitize.errors = FALSE)
options(gargle_oauth_email = TRUE)

# Set the knitting behavior
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      collapse = TRUE, 
                      results = 'hold',
                      cache = FALSE,
                      out.width = "100%",
                      fig.height = 5
)

packages <- c("htmlwidgets",
              "magrittr",
              "tidyverse",
              "googledrive",
              "knitr",
              "kableExtra",
              "plotly",
              "shiny",
              "DT",
              "revealjs"
)

# purrr::walk(packages, devtools::install_cran)
purrr::walk(packages, library, character.only = TRUE)

options(knitr.table.format = "html")

htmlwidgets::sizingPolicy(browser.fill = TRUE,
                          browser.padding = 0)

list.files("../R", full.names = TRUE) %>%
  purrr::walk(source)

```

## Crow Canyon's distribution policy {-}

> The trustees of endowed institutions are the guardians of the
future against the claims of the present. Their task is to preserve
equity among generations.<br>
> --- *James Tobin*, winner of the 1981 Nobel Prize in Economics


As described in [Crow Canyon's endowment distribution policy](https://drive.google.com/uc?export=download&id=0B3eLJVA9JyQYVkNCTXdYSkM5Tlk), Crow Canyon currently uses a formula to set endowment spending for the following-year. This formula is called the *Tobin Rule*, named for its creator who is quoted in the epigraph above.

The Tobin Rule defines next year's endowment distribution ($D$) as:

\begin{equation*} 
D = [p \times (1 + i) \times D_{\text{past}}] + [(1-p) \times r \times V]
\end{equation*} 

where,

$p$: the stability factor that weights the portion of the distribution that will be based on the previous year’s distribution as calculated by the Tobin Rule

$i$: the inflation rate; to the average annualized inflation rate from two years prior using the [Consumer Price Index](https://data.bls.gov/timeseries/CUUR0000SA0?output_view=pct_12mths){target="_blank"}

$D_{past}$: the previous year’s distribution amount

$r$: the distribution rate, or the proportion of the market value to be distributed

$V$: the market value

Compliant with the Colorado Uniform Prudent Management of Institutional Funds Act, C.R.S. 15-1-1104 (2008), the Crow Canyon Archaeological Center uses the following guidelines for employing the Tobin Rule to calculate the annual distribution from an endowed fund:

- Set $p=`r params$p`$ — weight the distribution `r params$p * 100`% towards stability, `r (1-params$p) * 100`% towards market performance.
- Set $r=`r params$r`$ — set the distribution rate to `r params$r * 100`%.
- Set $V$ (the market value used in the rule) to the end of year market value from two years prior (e.g., the `r params$year` distribution is based upon the December 31, `r params$year - 2` market value).
- Set $i$ (the inflation rate) to the average annualized inflation rate from two years prior (e.g., the `r params$year` distribution is based upon the `r params$year - 2` average annualized inflation, or the average of the year-over-year inflation rates in every month of `r params$year - 2`).
- When a new fund is established, hold the new fund in the investment account for two full fiscal quarters before any distributions are made from it. After two full quarters, distribute a quarterly proration of $r$ times the contributed value of the fund for each of the remaining quarters of the fiscal year. In the second fiscal year of distributions, distribute $r$ times the contributed value of the fund. Distribute as per the Tobin Rule in subsequent fiscal years.
- When new contributions are made to existing funds, they should be treated similarly to the establishment of new funds (as described above). After two full quarters in the investment account, distribute a quarterly proration of $r$ times the new contribution of the fund for each of the remaining quarters of the fiscal year. In the second fiscal year of distributions, distribute $r$ times the new contribution. Do not include a new contribution in the Tobin rule calculation during its first two years of distribution.
- Withdraw distributed funds even if doing so will cause a fund’s market value to become less than its contributed value.

### Data {-}

Data are read directly from federal and Crow Canyon sources. Inflation data are in a tab-seperated file provided by the Bureau of Labor Statistics at [https://download.bls.gov/pub/time.series/cu/cu.data.1.AllItems](https://download.bls.gov/pub/time.series/cu/cu.data.1.AllItems). Endowment data are from a [Google spreadsheet](https://docs.google.com/spreadsheets/d/1aSMKn4UMPT3mDQLLaPXpbEY-bLtfyZM2IHaZgZ81ADM/edit#gid=387790151) that provides quarterly endowment data.

The table below provides the current data for Crow Canyon's endowed funds.

```{r data}
endowments <- get_endowment_data(live_data = params$live_data)

inflation <- get_inflation(live_data = FALSE)

distribution_current <- 
  endowments %>%
  get_distribution(params$year - 1)

distribution_future <- 
  endowments %>%
  get_distribution(params$year)


cpi_monthly <- readr::read_tsv("./inflation.tsv") %>%
  dplyr::filter(series_id == "CUUR0000SA0",
                period != "M13") %>%
  dplyr::mutate(month = period %>% 
                  stringr::str_remove("M") %>%
                  stringr::str_c(year, ., sep = "-")) %>%
  dplyr::select(month, 
                value)

cpi_monthly <- cpi_monthly %$%
  value %>%
  magrittr::set_names(cpi_monthly$month)

cpi_monthly_cross <- 
  cpi_monthly %o% (1/cpi_monthly)

get_target <- function(x,month){
  out <- x / cpi_monthly_cross[month,][names(cpi_monthly_cross[month,]) >= month]
  tibble::tibble(month = names(out), `Target Value` = out)
}

target_values <- 
  endowments %>%
  # dplyr::filter(Fund == "Florence C. and Robert H. Lister Fellowship") %>%
  dplyr::select(Year,
                Month,
                Fund,
                `Contributions (monthly)`) %>%
  dplyr::mutate(month = Month %>%
                  stringr::str_pad(2,"left","0") %>%
                  stringr::str_c(Year,
                                 .,
                                 sep = "-")) %>%
  dplyr::arrange(month) %>%
  dplyr::group_by(Fund) %>%
  dplyr::summarise(`Target Value` = list(purrr::map2_dfr(.x = `Contributions (monthly)`,
                                                         .y = month,
                                                         .f = get_target))) %>%
  tidyr::unnest() %>%
  tidyr::separate(col = month,
                  into = c("Year", "Month"),
                  sep = "-") %>%
  dplyr::mutate(Year = as.integer(Year),
                Month = as.numeric(Month)) %>%
  dplyr::group_by(Fund,
                  Year,
                  Month) %>%
  dplyr::summarise_all(sum, na.rm = TRUE)

endowments %<>%
  dplyr::select(-`Target Value`) %>%
  dplyr::left_join(target_values, 
                   by = c("Fund", 
                          "Year", 
                          "Month"))

```

```{r current-values}
sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Fund'),
      # th(rowspan = 2, 'Department'),
      th(colspan = 3, 'Current Values'),
      th(colspan = 4, 'Benchmarks')
    ),
    tr(
      th("Contributed"),
      th("Target"),
      th("Market"),
      th("Market - Contributed"),
      th("Market / Contributed"),
      th("Market - Target"),
      th("Market / Target")
    )
  )
))



values_table <- endowments %>%
  dplyr::group_by(Fund) %>%
  dplyr::arrange(Fund,Year,Month) %>%
  dplyr::mutate(`Contributed Value` = cumsum(`Contributions (monthly)`)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Year == max(Year)) %>%
  dplyr::filter(Month == max(Month)) %>%
  dplyr::arrange(#Category,
    Fund) %>%
  dplyr::select(Fund,
                # Category,
                `Contributed Value`,
                `Target Value`,
                `Market Value`
  ) %>%
  dplyr::rename(Contributed = `Contributed Value`,
                Target = `Target Value`,
                Market = `Market Value`) %>%
  dplyr::mutate(`Market - Contributed` = Market - Contributed,
                `Market / Contributed` = Market / Contributed,
                `Market - Target` = Market - Target,
                `Market / Target` = Market / Target)

values_tab <- values_table %>%
  DT::datatable(container = sketch,
                style = "bootstrap",
                extensions = c('FixedColumns'
                ),
                options = list(
                  dom = 'rt',
                  scrollX = TRUE,
                  fixedColumns = list(leftColumns = 1),
                  pageLength = 10,
                  columnDefs = list(list(width = 200, targets = 0)),
                  autoWidth = TRUE,
                  paging = FALSE,
                  scrollResize = TRUE,
                  scrollY = 300,
                  scrollCollapse = TRUE
                ),
                rownames = FALSE,
                escape = FALSE) %>%
  DT::formatStyle(
    columns = c('Market - Contributed',
                'Market - Target'),
    color = styleInterval(c(0), c('red', 'black'))
  ) %>%
  DT::formatStyle(
    columns = c('Market / Contributed',
                'Market / Target'),
    color = styleInterval(c(1), c('red', 'black'))
  ) %>%
  DT::formatCurrency(columns = c('Contributed', 
                                 'Target',
                                 'Market',
                                 'Market - Contributed',
                                 'Market - Target'),
                     digits = 0) %>% 
  DT::formatPercentage(columns = c('Market / Contributed',
                                   'Market / Target'), 
                       digits = 1) %>%
  add_dependency(htmltools::htmlDependency(name = "table",
                                           version = "0.0.0",
                                           src = c(file = "../src/"),
                                           script = "dataTables.scrollResize.min.js"
  ))

values_tab %T>%
  save_table(file = "./ccac_endowments_current_table.html", 
             title = "Current Endowment Values")

```

## The Crow Canyon `r params$year - 1` distributions {-}

The policy above is applied to the distribution of every endowed fund. The Tobin calculation depends on the market value from two years prior, and the previous year's distribution adjusted for the annualized inflation from two years prior, as well as new contributions posted within the last two years. According to Crow Canyon's endowment spending policy, new contributions or newly estabilished funds are distributed at `r params$r * 100`% of their contributed value for the first two years of distributions, after a two quarter waiting period. The table below shows the endowment distribution for `r params$year - 1`. **The total distribution in `r params$year - 1` is `r distribution_current[['Total Distribution']] %>% sum(na.rm = TRUE) %>% format.money()`.** This is likely to increase with additional contributions in the first quarter of `r params$year - 1`. The annualized inflation at the end of `r params$year - 3` was `r inflation %>% dplyr::filter(year == params$year - 3) %$% inflation * 100`%.


```{r tobin_table_past}
sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Fund'),
      # th(rowspan = 2, 'Department'),
      th(colspan = 5, paste0(params$year - 1,' Distribution')),
      th(colspan = 2, paste0(params$year - 1,' Spending'))
    ),
    tr(
      th("Tobin"),
      th("Year 1"),
      th("Year 2"),
      th("Rollover"),
      th("Total"),
      th("Spent"),
      th("Remaining")
    )
  )
))

dist_table_current <- distribution_current %>%
  dplyr::select(-`Market Value`:-`D<sub>past</sub>`) %>%
  dplyr::left_join(endowments %>%
                     dplyr::filter(Year == max(Year)) %>%
                     dplyr::filter(Month == max(Month)) %>%
                     dplyr::select(Fund, 
                                   Category, 
                                   Distributions,
                                   `Market Value`),
                   by = "Fund") %>%
  dplyr::mutate(`Tobin` = `Tobin stability` + `Tobin market`,
                `Year 1` = `Y1-Q1` + `Y1-Q2` + `Y1-Q3` + `Y1-Q4`,
                `Year 2` = Y2,
                Total = `Tobin` + `Year 1` + `Year 2` + Rollover,
                `Spent` = -1 * Distributions,
                `Remaining` = Total - `Spent`
  ) %>%
  dplyr::arrange(#Category,
    Fund) %>%
  dplyr::select(Fund,
                # Category,
                `Tobin`,
                `Year 1`,
                `Year 2`,
                Rollover,
                Total,
                `Spent`,
                `Remaining`)

dist_tab <- dist_table_current %>%
  DT::datatable(container = sketch,
                style = "bootstrap",
                extensions = c('FixedColumns'#, 
                               #'Buttons'
                               ),
                options = list(
                  dom = 'rt',
                  scrollX = TRUE,
                  fixedColumns = list(leftColumns = 1),
                  pageLength = 10,
                  columnDefs = list(list(width = 200, targets = 0)),
                  autoWidth = TRUE,
                  paging = FALSE,
                  scrollResize = TRUE,
                  scrollY = 300,
                  scrollCollapse = TRUE
                ),
                rownames = FALSE,
                escape = FALSE)  %>%
  DT::formatStyle(
    columns = c('Remaining'),
    color = styleInterval(c(0), c('red', 'black'))
  ) %>%
  DT::formatCurrency(columns = c('Tobin', 
                                 'Year 1',
                                 'Year 2',
                                 'Rollover',
                                 'Total',
                                 'Spent',
                                 'Remaining'),
                     digits = 0) %>% 
  add_dependency(htmltools::htmlDependency(name = "table",
                                           version = "0.0.0",
                                           src = c(file = "../src/"),
                                           script = "dataTables.scrollResize.min.js"
  ))

dist_tab %T>%
  save_table(file = paste0("./ccac_endowments_",params$year - 1,"_table.html"), 
             title = paste0("The Crow Canyon ",params$year - 1," distributions"))

```

## The Crow Canyon `r params$year` distributions {-}

The same calculations apply to the `r params$year` distributions. **The total distribution in `r params$year` is `r distribution_future[['Total Distribution']] %>% sum(na.rm = TRUE) %>% format.money()`.** This is likely to increase with additional contributions in `r params$year - 1` and the first quarter of `r params$year`. The annualized inflation at the end of `r params$year - 2` was `r inflation %>% dplyr::filter(year == params$year - 2) %$% inflation * 100`%.

```{r tobin_table}

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Fund'),
      # th(rowspan = 2, 'Department'),
      th(colspan = 5, paste0(params$year,' Distribution'))
    ),
    tr(
      th("Tobin"),
      th("Year 1"),
      th("Year 2"),
      th("Rollover"),
      th("Total")
    )
  )
))

dist_table_future <- distribution_future %>%
  dplyr::mutate_all(tidyr::replace_na,0) %>%
  dplyr::select(-`Market Value`:-`D<sub>past</sub>`) %>%
  dplyr::left_join(endowments %>%
                     dplyr::filter(Year == max(Year)) %>%
                     dplyr::filter(Month == max(Month)) %>%
                     dplyr::select(Fund, 
                                   # Category, 
                                   Distributions,
                                   `Market Value`),
                   by = "Fund") %>%
  dplyr::mutate(`Tobin` = `Tobin stability` + `Tobin market`,
                `Year 1` = `Y1-Q1` + `Y1-Q2` + `Y1-Q3` + `Y1-Q4`,
                `Year 2` = Y2,
                Total = `Tobin` + `Year 1` + `Year 2` + Rollover
  ) %>%
  dplyr::arrange(#Category,
    Fund) %>%
  dplyr::select(Fund,
                # Castegory,
                `Tobin`,
                `Year 1`,
                `Year 2`,
                Rollover,
                Total)

dist_tab <- 
  dist_table_future %>%
  DT::datatable(container = sketch,
                style = "bootstrap",
                extensions = c('FixedColumns'),
                options = list(
                  dom = 'rt',
                  scrollX = TRUE,
                  fixedColumns = list(leftColumns = 1),
                  pageLength = 10,
                  columnDefs = list(list(width = 200, targets = 0)),
                  autoWidth = TRUE,
                  paging = FALSE,
                  scrollResize = TRUE,
                  scrollY = 300,
                  scrollCollapse = TRUE
                ),
                rownames = FALSE,
                escape = FALSE)  %>%
  
  DT::formatCurrency(columns = c('Tobin', 
                                 'Year 1',
                                 'Year 2',
                                 'Rollover',
                                 'Total'),
                     digits = 0) %>% 
  add_dependency(htmltools::htmlDependency(name = "table",
                                           version = "0.0.0",
                                           src = c(file = "../src/"),
                                           script = "dataTables.scrollResize.min.js"
  ))

dist_tab %T>%
  save_table(file = paste0("./ccac_endowments_",params$year,"_table.html"), 
             title = paste0("The Crow Canyon ",params$year," distributions"))

```

## Historical analysis {- .tabset .tabset-dropdown}
Here, we summarise the history of Crow Canyon's endowments and distributions. First, we show the history of the market value of the corpus, its contributed value, and its target value (inflation-adjusted contributed value). Then, we show the distributions through time with new distributions projected out two years from the close of `r params$year - 2`.

In both graphs, the black line represents the actual endowment values and distributions and the <red style="color:red;">red</red> lines represent the target values and distributions.

### Market Value {-}

```{r value_plot}
endowments %<>%
  dplyr::group_by(Fund) %>%
  dplyr::arrange(Fund,Year,Month) %>%
  dplyr::mutate(`Contributed Value` = cumsum(`Contributions (monthly)`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Date = lubridate::ymd(paste(Year,Month,"01",sep="-")),
                Date = lubridate::ymd(paste(lubridate::year(Date),
                                            lubridate::month(Date),
                                            lubridate::days_in_month(Date)))) %>%
  dplyr::select(Date,
                dplyr::everything()) %>%
  dplyr::mutate(Distribution = 
                  `Approved Distribution (Tobin)` +
                  `Approved Distribution (New Y1)` + 
                  `Approved Distribution (New Y2)`,
                Distribution = ifelse(Date < lubridate::ymd("2019-01-01"),
                                      (-1 * Distributions),
                                      Distribution))


fund_order <-
  endowments %>%
  dplyr::filter(`Contributed Value` > 0) %>%
  dplyr::group_by(Fund) %>%
  dplyr::summarise(Start_date = min(Date),
                   End_date = max(Date)) %>%
  dplyr::arrange(Start_date,End_date,Fund) %$%
  Fund %>%
  rev()

endowments %<>%
  dplyr::mutate(Fund = factor(Fund,
                              levels = 
                                fund_order, 
                              ordered = TRUE))


endowments_net <- 
  endowments %>%
  dplyr::select(Date,
                `Contributed Value`,
                `Target Value`,
                `Market Value`,
                Distribution) %>%
  dplyr::group_by(Date) %>%
  dplyr::summarise_all(sum, na.rm = TRUE)

(endowments %>%
    ggplot() +
    geom_area(mapping = aes(x=Date,
                            y=`Market Value`/1000000,
                            fill = Fund,
                            group = Fund,
                            text = paste0("<b>",Fund,"</b>\n",
                                          Date, " Market Value: ", format.money(round(`Market Value`)),"\n",
                                          Date, " Contributed Value: ", format.money(round(`Contributed Value`)),"\n",
                                          Date, " Target Value: ", format.money(round(`Target Value`))
                            )),
              show.legend = FALSE) +
    scale_fill_hue(c = 50, 
                   l = 70, 
                   h=c(270, 150)) +
    geom_line(data = endowments_net,
              mapping = aes(x = Date,
                            y = `Market Value`/1000000,
                            text = paste0("<b>Corpus</b>\n",
                                          Date, " Market Value: ", format.money(round(`Market Value`)),"\n",
                                          Date, " Contributed Value: ", format.money(round(`Contributed Value`)),"\n",
                                          Date, " Target Value: ", format.money(round(`Target Value`)))),
              color = "black",
              group = 1,
              inherit.aes = FALSE) +
    geom_line(data = endowments_net,
              mapping = aes(x = Date,
                            y = `Target Value`/1000000,
                            text = paste(Date, "Target Value:", format.money(round(`Target Value`)))),
              color = "red",
              lty = 1,
              group = 1,
              inherit.aes = FALSE) +
    geom_line(data = endowments_net,
              mapping = aes(x = Date,
                            y = `Contributed Value`/1000000,
                            text = paste(Date, "Contributed Value:", format.money(round(`Contributed Value`)))),
              color = "black",
              lty = 3,
              group = 1,
              inherit.aes = FALSE) +
    scale_x_date(limits = c(lubridate::ymd("1996-12-31"), lubridate::today()), 
                 expand = c(0,1),
                 date_breaks = "1 years",
                 labels = function(x){lubridate::year(x)}) +
    scale_y_continuous(limits = c(0, 30),
                       expand = c(0,0)) +
    xlab("Year") +
    ylab("Value (millions of USD)") +
    theme(plot.margin = margin(0,0.5,0,0, unit = "cm"))) %>%
  plotlyer() %>%
  layout(showlegend = FALSE) %>%
  highlight(on = "plotly_selected", selectize = TRUE) %T>%
  htmlwidgets::saveWidget("./endowment_model_market.html")

```

### Distributions {-}

```{r distribution_plot}

endowments_eoy <- 
  endowments %>%
  dplyr::filter(lubridate::month(Date) == 12) %>%
  dplyr::bind_rows(distribution_current %>%
                     dplyr::mutate_all(tidyr::replace_na, 0) %>%
                     dplyr::mutate(Distribution = 
                                     `Tobin stability` +
                                     `Tobin market` +
                                     `Y1-Q1` +
                                     `Y1-Q2` +
                                     `Y1-Q3` +
                                     `Y1-Q4` +
                                     `Y2`,
                                   Date = lubridate::ymd(paste(params$year - 1,"12-31",sep = "-"))) %>%
                     dplyr::select(Date, Fund, Distribution)) %>%
  dplyr::bind_rows(distribution_future %>%
                     dplyr::mutate_all(tidyr::replace_na, 0) %>%
                     dplyr::mutate(Distribution = 
                                     `Tobin stability` +
                                     `Tobin market` +
                                     `Y1-Q1` +
                                     `Y1-Q2` +
                                     `Y1-Q3` +
                                     `Y1-Q4` +
                                     `Y2`,
                                   Date = lubridate::ymd(paste(params$year,"12-31",sep = "-"))) %>%
                     dplyr::select(Date, Fund, Distribution)) %>%
  dplyr::select(Date, 
                Fund, 
                `Contributed Value`, 
                `Target Value`,
                `Market Value`,
                Distribution) %>%
  tidyr::complete(Date, Fund, fill = list(`Contributed Value` = 0, 
                                          `Target Value` = 0,
                                          `Market Value` = 0,
                                          Distribution = 0)) %>%
  dplyr::arrange(Fund, Date) %>%
  dplyr::mutate(`Contributed Value` = ifelse(lubridate::year(Date) %in% c(2020,2021),NA,`Contributed Value`),
                `Target Value` = ifelse(lubridate::year(Date) %in% c(2020,2021),NA,`Target Value`),
                `Market Value` = ifelse(lubridate::year(Date) %in% c(2020,2021),NA,`Market Value`)) %>%
  dplyr::mutate(Date = lubridate::year(Date))

endowments_net_eoy <-
  endowments_eoy %>%
  dplyr::group_by(Date) %>%
  dplyr::summarise_if(is.numeric, sum)

(endowments_eoy %>%
    # dplyr::filter(Fund == "Research Institute Endowment Fund") %>%
    dplyr::mutate(Year = lubridate::year(Date),
                  Distribution = as.integer(Distribution)) %>%
    dplyr::select(Year, Fund, Distribution) %>%
    dplyr::distinct() %>%
    ggplot() +
    geom_area(mapping = aes(x=Year,
                            y=`Distribution`/1000000,
                            fill = Fund,
                            group = Fund,
                            text = paste(Fund,"\n",
                                         Year, "Distribution:", format.money(round(`Distribution`)))),
              show.legend = FALSE) +
    scale_fill_hue(c = 50, 
                   l = 70, 
                   h=c(270, 150)) +
    geom_line(data = endowments_net_eoy,
              mapping = aes(x = lubridate::year(Date),
                            y = `Distribution`/1000000,
                            text = paste(lubridate::year(Date), "Actual Distribution:", format.money(round(`Distribution`)))),
              group = 1,
              inherit.aes = FALSE,
              linetype = 1) +
    geom_line(data = endowments_net_eoy,
              mapping = aes(x = lubridate::year(Date) + 1,
                            y = params$r * `Target Value`/1000000,
                            text = paste(lubridate::year(Date), "Target Distribution:", format.money(round(params$r * `Target Value`)))),
              color = "red",
              group = 1,
              inherit.aes = FALSE,
              linetype = 1) +
    geom_line(data = endowments_net_eoy,
              mapping = aes(x = lubridate::year(Date) + 1,
                            y = params$r * `Contributed Value`/1000000,
                            text = paste(lubridate::year(Date), "Contributed Distribution:", format.money(round(params$r * `Contributed Value`)))),
              color = "black",
              group = 1,
              inherit.aes = FALSE,
              linetype = 3) +
    scale_x_continuous(limits = c(1996, params$year),
                       breaks = 1996:params$year,
                       expand = c(0,0)) +
    scale_y_continuous(limits = c(0, 1.25),
                       expand = c(0,0)) +
    xlab("Year") +
    ylab("Distribution (millions of USD)") +
    theme(plot.margin = margin(0,0.5,0,0, unit = "cm"))) %>%
  plotlyer() %>%
  layout(showlegend = FALSE) %>%
  highlight(on = "plotly_selected", 
            # persistent = TRUE, 
            selectize = TRUE) %T>%
  htmlwidgets::saveWidget("./endowment_model_distribution.html")


(endowments_eoy %>%
    ggplot() +
    geom_area(mapping = aes(x=Date,
                            y=`Market Value`/1000000,
                            fill = Fund,
                            group = Fund,
                            text = paste0("<b>",Fund,"</b>\n",
                                          Date, " Market Value: ", format.money(round(`Market Value`)),"\n",
                                          Date, " Contributed Value: ", format.money(round(`Contributed Value`)),"\n",
                                          Date, " Target Value: ", format.money(round(`Target Value`))
                            )),
              show.legend = FALSE) +
    scale_fill_hue(c = 50, 
                   l = 70, 
                   h=c(270, 150)) +
    geom_line(data = endowments_net_eoy,
              mapping = aes(x = Date,
                            y = `Market Value`/1000000,
                            text = paste0("<b>Net</b>\n",
                                          Date, " Market Value: ", format.money(round(`Market Value`)),"\n",
                                          Date, " Contributed Value: ", format.money(round(`Contributed Value`)),"\n",
                                          Date, " Target Value: ", format.money(round(`Target Value`)))),
              color = "red",
              group = 1,
              inherit.aes = FALSE,
              size = 1.5) +
    
    geom_line(data = endowments_net_eoy,
              mapping = aes(x = Date,
                            y = (`Distribution`/1000000) * 20,
                            text = paste0("<b>Net</b>\n",
                                          Date, " Distribution: ", format.money(round(`Distribution`)))),
              color = "black",
              group = 1,
              inherit.aes = FALSE,
              size = 1.5) +
    
    scale_x_continuous(limits = c(1997, max(endowments_eoy$Date)), 
                       breaks = seq(1997,max(endowments_eoy$Date),1),
                       expand = c(0,1)) +
    scale_y_continuous("Year-end Value (millions of USD)",
                       limits = c(0, 25),
                       expand = c(0, 0),
                       sec.axis = sec_axis(~ . / 20, name = "Distribution (millions of USD)")) +
    xlab("Year") +
    theme_grey(base_size = 24) +
    theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
          axis.title.y.left = element_text(color = "red"),
          axis.text.y.left = element_text(color = "red"),
          axis.ticks.y.left = element_line(color = "red")))
# %>%
#   plotlyer() %>%
#   layout(showlegend = FALSE,
#          yaxis2 = list(
#   tickfont = list(color = "red"),
#   overlaying = "y",
#   side = "right",
#   title = "second y axis"
# ),
#     xaxis = list(title="x")) %>%
#   highlight(on = "plotly_selected", selectize = TRUE) %T>%
#   htmlwidgets::saveWidget("./endowment_model_market.html")

ggplot2::ggsave("./value_vs_distributions.pdf",
                width = 20.96,
                height = 8.67,
                device = cairo_pdf)



```

```{r build-presentation, echo=FALSE}
rmarkdown::render("./presentation.Rmd")
```

```{r export-data, echo=FALSE}

list(
  values_table,
  dist_table_current,
  dist_table_future,
  inflation %>%
    dplyr::filter(year %in% endowments$Year),
  endowments %>%
    dplyr::select(-Date,
                  -`Target Value`:-Distribution)
) %>%
  magrittr::set_names(
    c(
      "Current Values",
      paste0(params$year - 1," Distributions"),
      paste0(params$year," Distributions"),
      "Inflation",
      "Historical Data"
    )) %>%
  writexl::write_xlsx("./CCAC_endowment_data.xlsx")

```
